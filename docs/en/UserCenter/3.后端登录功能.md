æœ¬æ¬¡ç›´æ’­å†…å®¹ï¼š

1. ä¸Šæ¬¡ç›´æ’­é—®é¢˜æ€»ç»“âœ”
2. ç”¨æˆ·åº“è¡¨è®¾è®¡âœ”
3. å®Œæˆç™»å½•æ³¨å†Œçš„å‰åç«¯å¼€å‘ğŸ“Œ
4. å®Œæˆç”¨æˆ·ç®¡ç†åå°çš„å‰åç«¯å¼€å‘ğŸ“Œ

# è®¡åˆ’

1. åˆå§‹åŒ–é¡¹ç›® âœ”

   1. å‰ç«¯åˆå§‹åŒ–  âœ”

      1. åˆå§‹åŒ–é¡¹ç›® 
      2. å¼•å…¥ä¸€äº›ç»„ä»¶ä¹‹ç±»çš„ 
      3. æ¡†æ¶ä»‹ç» / ç˜¦èº« 

   2. åç«¯åˆå§‹åŒ–  20 min  âœ”

      1. å‡†å¤‡ç¯å¢ƒï¼ˆMySQL ä¹‹ç±»çš„ï¼‰éªŒè¯ MySQL æ˜¯å¦å®‰è£…æˆåŠŸ - è¿æ¥ä¸€ä¸‹ 
      2. åˆå§‹åŒ–åç«¯é¡¹ç›®ï¼Œå¼•å…¥æ¡†æ¶ï¼ˆæ•´åˆæ¡†æ¶ï¼‰
2. æ•°æ®åº“è®¾è®¡  âœ”
3. **ç™»å½• / æ³¨å†Œ** ğŸ“Œ
   1. åç«¯  âœ”
      1. è§„æ•´é¡¹ç›®ç›®å½•  âœ”
      2. å®ç°åŸºæœ¬æ•°æ®åº“æ“ä½œï¼ˆæ“ä½œ user è¡¨ï¼‰ âœ”
         1. æ¨¡å‹ user å¯¹è±¡ => å’Œæ•°æ®åº“çš„å­—æ®µå…³è”ï¼Œè‡ªåŠ¨ç”Ÿæˆ  âœ”
         1. æµ‹è¯• âœ”
      3. å†™æ³¨å†Œé€»è¾‘ï¼ŒåŠŸèƒ½å’Œæµ‹è¯• âœ”
      4. å†™ç™»å½• åŠŸèƒ½å’Œæµ‹è¯• ğŸ“Œ
         1. å¼€å‘å®Œæˆåç«¯ç™»å½•åŠŸèƒ½ï¼ˆå…ˆå•æœºç™»å½• => åç»­æ”¹é€ ä¸ºåˆ†å¸ƒå¼ / ç¬¬ä¸‰æ–¹ç™»å½•ï¼‰ğŸ“Œ
         2. ï¼ˆç®¡ç†å‘˜ç”¨æˆ·ç®¡ç†ï¼‰å¼€å‘åç«¯ç”¨æˆ·çš„ç®¡ç†æ¥å£ï¼Œç”¨æˆ·çš„æŸ¥è¯¢ / çŠ¶æ€æ›´æ”¹ã€‚ğŸ“Œ
         3. åç«¯æ¥å£æµ‹è¯• ğŸ“Œ
   2. å‰ç«¯ ğŸ“Œ
      1. åˆ é™¤å¤šä½™ä»£ç  ğŸ“Œ
      2. æ³¨å†ŒåŠŸèƒ½ ğŸ“Œ
      3. è·å–ç”¨æˆ·çš„ç™»å½•æ€ï¼Œ**è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯æ¥å£**  ğŸ“Œ
      4. å¼€å‘å‰ç«¯ç”¨æˆ·ç™»å½•æ³¨å†ŒåŠŸèƒ½ 
      5. è®¨è®ºå¦‚ä½•æ ¡éªŒç”¨æˆ·ï¼ˆæ˜Ÿçƒçš„å°ä¼™ä¼´å¯ä»¥ä½¿ç”¨ï¼‰
4. ç®¡ç†å‘˜ç”¨æˆ·ç®¡ç†

   2. åç«¯ 
   2. å‰ç«¯

# å‰ç¯‡é‡è¦çš„è®¾è®¡ Previously on

## æ•°æ®åº“è®¾è®¡ 30 min

| Field / Name                |                                        | Status                     | Type                    |
| :-------------------------- | -------------------------------------- | -------------------------- | ----------------------- |
| id                          | ä¸»é”®                                   | Primary key, Auto inc      | bigint                  |
| username                    | æ˜µç§°                                   |                            | varchar(256)            |
| userAccount                 | ç™»å½•è´¦å·                               |                            | varchar(256)            |
| avatarUrl                   | å¤´åƒ                                   |                            | varchar(1024)           |
| gender                      | æ€§åˆ«                                   |                            | tinyint                 |
| userPassword                | å¯†ç                                    | Not Null                   | varchar(512)            |
| phone                       | ç”µè¯                                   |                            | varchar(128)            |
| email                       | é‚®ç®±                                   |                            | varchar(512)            |
| userStatus                  | ç”¨æˆ·çŠ¶æ€                               | Not Null, Default: 0       | intï¼ˆæ­£å¸¸ï¼Œå°å·ï¼Œè¿‡æœŸï¼‰ |
| createTime                  | åˆ›å»ºæ—¶é—´ï¼ˆæ•°æ®æ’å…¥æ—¶é—´ï¼‰               | Default: CURRENT_TIMESTAMP | datetime                |
| updateTime                  | æ›´æ–°æ—¶é—´ï¼ˆæ•°æ®æ›´æ–°æ—¶é—´ï¼‰               | Default: CURRENT_TIMESTAMP | datetime                |
| isDelete                    | æ˜¯å¦åˆ é™¤ï¼ˆé€»è¾‘åˆ é™¤ 0 1ï¼Œä¸æ˜¯çœŸçš„åˆ é™¤ï¼‰ | Not Null, Default: 0       | tinyint                 |
| !!! role (late development) | ç”¨æˆ·è§’è‰²                               | Not Null, Default: 0       | int                     |

## æ³¨å†Œé€»è¾‘

1. ç”¨æˆ·åœ¨å‰ç«¯è¾“å…¥è´¦æˆ·å’Œå¯†ç ã€ä»¥åŠæ ¡éªŒç ï¼ˆtodoï¼‰
2. æ ¡éªŒç”¨æˆ·çš„è´¦æˆ·ã€å¯†ç ã€æ ¡éªŒå¯†ç ï¼Œæ˜¯å¦ç¬¦åˆè¦æ±‚
   1. éç©º
   2. è´¦æˆ·é•¿åº¦ **ä¸å°äº** 4 ä½
   3. å¯†ç å°± **ä¸å°äº** 8 ä½å§
   4. è´¦æˆ·ä¸èƒ½é‡å¤
   5. è´¦æˆ·ä¸åŒ…å«ç‰¹æ®Šå­—ç¬¦
   6. å¯†ç å’Œæ ¡éªŒå¯†ç ç›¸åŒ
3. å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼ˆå¯†ç åƒä¸‡ä¸è¦ç›´æ¥ä»¥æ˜æ–‡å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼‰
4. å‘æ•°æ®åº“æ’å…¥ç”¨æˆ·æ•°æ®



# åç«¯ - ç™»å½•åŠŸèƒ½

## åˆ†æç™»å½•é€»è¾‘

1. æ ¡éªŒç”¨æˆ·è´¦æˆ·å’Œå¯†ç æ˜¯å¦åˆæ³•

   1. éç©º
   2. è´¦æˆ·é•¿åº¦ **ä¸å°äº** 4 ä½
   3. å¯†ç å°± **ä¸å°äº** 8 ä½å§
   4. è´¦æˆ·ä¸åŒ…å«ç‰¹æ®Šå­—ç¬¦

2. æ ¡éªŒå¯†ç æ˜¯å¦è¾“å…¥æ­£ç¡®ï¼ŒåŠ å¯†åè¦å’Œæ•°æ®åº“ä¸­çš„å¯†æ–‡å¯†ç å»å¯¹æ¯”ï¼ŒæŸ¥è¯¢ç”¨æˆ·çŸ¥å¦å­˜åœ¨

3. ç”¨æˆ·ä¿¡æ¯è„±æ•ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰é˜²æ­¢æ•°æ®åº“ä¸­çš„å­—æ®µæ³„éœ²ç»™å‰ç«¯ã€‚

4. è®°å½•ç”¨æˆ·çš„ç™»å½•æ€ï¼ˆsession ä¼šè¯ -> cookieï¼‰ï¼Œå°†å…¶å­˜åˆ°æœåŠ¡å™¨ä¸Šï¼ˆç”¨åç«¯ SpringBoot æ¡†æ¶å°è£…çš„æœåŠ¡å™¨ tomcat å»è®°å½•ï¼‰

   > Cookie å’Œ Session ä¹‹é—´çš„åŒºåˆ«ï¼ˆâ€œç®€å•è¯´æ˜cookieå’Œsessionâ€ --- ç‚ï¼‰

5. è¿”å›è„±æ•åçš„ç”¨æˆ·ä¿¡æ¯ã€‚

## è®¾è®¡ç™»å½•åŠŸèƒ½

æ¥å—å‚æ•°ï¼šç”¨æˆ·è´¦æˆ·ã€å¯†ç 

è¯·æ±‚ç±»å‹ï¼š**POST** ï¼ˆGETé€šå¸¸ç”¨äºæ•°æ®è¯·æ±‚ï¼Œè¯·æ±‚å‚æ•°çš„å­—ç¬¦é•¿åº¦ä¼šæœ‰é™åˆ¶ï¼‰

> è¯·æ±‚å‚æ•°å¾ˆé•¿æ—¶ä¸å»ºè®®ç”¨ get

è¯·æ±‚ä½“ï¼š**JSON** æ ¼å¼çš„æ•°æ®ï¼ˆJSONï¼šå‰åç«¯ä¼ é€’æ•°æ®çš„æ ¼å¼ï¼‰

è¿”å›å€¼ï¼šç”¨æˆ·ä¿¡æ¯ï¼ˆ **è„±æ•**ï¼Œä¸èƒ½è¿”å›å¯†ç ï¼Œç”¨æˆ·éšç§ç­‰ï¼‰



## å®ç°ä¸šåŠ¡é€»è¾‘å±‚ - ç¼–å†™`UserService`æ–¹æ³•

> æ–¹æ³•å’Œæ¥å£çš„åŒºåˆ«ï¼š
>
> æ–¹æ³•é€šå¸¸æŒ‡åç«¯ **å…·ä½“å®ç°ä¸šåŠ¡é€»è¾‘çš„æ–¹æ³•**ã€‚
>
> â€‹	å¦‚ï¼šService å±‚ã€‚æ˜¯å¯¹ä¸šåŠ¡é€»è¾‘çš„æ ¡éªŒï¼ˆæœ‰å¯èƒ½è¢« controller ä¹‹å¤–çš„ç±»è°ƒç”¨ï¼‰
>
> æ¥å£éœ€è¦æ ¹æ®åç«¯çš„ä¸šåŠ¡é€»è¾‘æ–¹æ³•è¿›è¡Œå°è£…ï¼Œç„¶åä¾›å‰ç«¯ä½¿ç”¨ã€‚å°½é‡ä¸æ¶‰åŠä¸šåŠ¡é€»è¾‘æœ¬èº«ã€‚
>
> â€‹	å¦‚ï¼šController å±‚ã€‚å€¾å‘äºå¯¹è¯·æ±‚å‚æ•°æœ¬èº«çš„æ ¡éªŒï¼Œä¸æ¶‰åŠä¸šåŠ¡é€»è¾‘æœ¬èº«ï¼ˆè¶Šå°‘è¶Šå¥½ï¼‰
>

### 1. `UserService` åˆå§‹åŒ–

åœ¨ `service.UserService.java` é‡Œå†™ä¸šåŠ¡é€»è¾‘ï¼Œå¦‚ï¼šæœ¬æ¬¡çš„ç™»å½•ã€‚

### 2. å®šä¹‰ç™»å½•æ–¹æ³•

```java
/**
* @param userAccount
* @param userPAssword
* @return user information 
*/
User userLogin(String userAccount, String userPassword);
```

é€‰ä¸­ `userLogin(...)` -> Click alt+enter -> "Implement method 'userLogin' " 

### 3. æ ¡éªŒç”¨æˆ·è´¦æˆ·å’Œå¯†ç æ˜¯å¦åˆæ³•

å¯ç”¨ `Slf4j` æ—¥å¿—ï¼Œå¯åœ¨ä»£ç ä¸­åªç”¨ `log.` æ¥è®°å½•æ—¥è®°ã€‚å½“åé¢ç³»ç»Ÿå‡ºäº†é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ—¥å¿—ä¸­å»æŸ¥æ‰¾ã€‚

```java
@Service
@Slf4j 		// <--- Slf4j here
public class UserServiceImpl extends...
```

ä»å‰é¢æ³¨å†Œ`userRegister()`æ–¹æ³•ä¸‹å¤åˆ¶ä»¥ä¸‹ä»£ç åˆ° `userLogin()`ï¼ˆå› ä¸ºå…¶éƒ½æ˜¯æ ¡éªŒç”¨æˆ·è¾“å…¥ï¼Œå¯ä»¥é€šç”¨ï¼‰

* 1) è´¦æˆ·ä¸ºç©ºï¼Œ2) è´¦æˆ·é•¿åº¦å°äº4ï¼Œ3) è´¦æˆ·å¯†ç é•¿åº¦å°äº8ï¼Œ5) è´¦æˆ·åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œï¼ˆä¸åŒ…å« 4) å¯†ç å’Œç¡®è®¤å¯†ç é‡å¤ï¼Œ6) å’Œå·²æœ‰è´¦æˆ·é‡å¤ï¼‰

æŠŠæ‰€æœ‰çš„ `return -1` æ”¹æˆ `return null`ã€‚

æŠŠæ‰€æœ‰åŒ…å« `confirmPAssword` çš„ä»£ç åˆ æ‰ã€‚

**"æ ¡éªŒç”¨æˆ·è´¦æˆ·å’Œå¯†ç æ˜¯å¦åˆæ³•" æœ€ç»ˆä»£ç **

```java
// 1 User account and password can't be null
if(StringUtils.isAnyBlank(userAccount, userPassword)){
    return null;
}

// 2 User Account can't be shorter than length of 4
if(userAccount.length() < 4){
    return null;
}

// 3 User password can't be shorter than length of 8
if(userPassword.length() < 8){
    return null;
}

// 4 User account can't contain special characters
String regex = "[^a-zA-Z0-9]";
Matcher matcher = Pattern.compile(regex).matcher(userAccount);
if(matcher.find()){
    return null;
}

```



### 4. æ ¡éªŒç™»å½•å¯†ç 

ä»å‰é¢æ³¨å†Œ`userRegister()`æ–¹æ³•ä¸‹å¤åˆ¶ä»¥ä¸‹ä»£ç åˆ° `userLogin()`ï¼šç”¨æˆ·è´¦å·æŸ¥è¯¢ï¼ŒåŠ å¯†

```java
// Password encryption
String encryptedPassword = DigestUtils.md5DigestAsHex((SALT + userPassword).getBytes());

//   User account can't be duplicate (account already exist) [database query]
QueryWrapper<User> queryWrapper = new QueryWrapper<>();
queryWrapper.eq("userAccount", userAccount);
long count = userMapper.selectCount(queryWrapper);
    if(count > 0){
    return -1;
}
```



æŠŠ `SALT` æå–å‡ºæ¥ï¼Œåˆ°ä¸€ä¸ªå…¬ç”¨çš„å€¼ï¼Œé¿å…å¤šä¸ªç›ä¸ä¸€æ ·ã€‚

1. åœ¨å±æ€§é‡Œå®šä¹‰å”¯ä¸€ç› 

   ```java
   /**
   * Salt for password encryption 
   */
   private static final String SALT = "becoze"
   ```

   > `private static final` å¯ä»¥å…ˆè¾“å…¥ `prsf`ï¼ŒæŒ‰ä¸‹enterå¿«é€Ÿç”Ÿæˆ

2. åˆ é™¤æ³¨å†Œå’Œç™»å½•é‡Œçš„ä»£ç  

   ```java
   // 2. Password encryption
   final String SALT = "becoze";   // <--- åˆ é™¤
   String encryptedPassword = DigestUtils.md5DigestAsHex((SALT + userPassword).getBytes());
   ```

   

å¼•å…¥ Mybatis-Plus é€»è¾‘åˆ é™¤ï¼Œå¸®åŠ©æˆ‘ä»¬å®ç°é€»è¾‘åˆ é™¤ã€‚**é¿å…æŸ¥è¯¢ç”¨æˆ·æ—¶å› å…¶è´¦æˆ·è¢«é€»è¾‘åˆ é™¤ï¼Œä»è€Œè¿”å›é”™è¯¯ä¿¡æ¯ã€‚**

[MyBatis-Plue å®˜ç½‘ - é€»è¾‘åˆ é™¤](https://www.baomidou.com/pages/6b03c5/)

é…ç½®ï¼šåˆ° `resource.applicaiton.yml` å¤åˆ¶ä»£ç ï¼Œç„¶åç²˜è´´ã€‚æœ€ç»ˆä»£ç å¦‚ä¸‹ï¼ˆåŒ…æ‹¬ä¹‹å‰çš„é…ç½®ï¼‰

```yml
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: false
    
  global-config:
    db-config:
      logic-delete-field: isDelete  # Entity field name for global logical deletion
      logic-delete-value: 1         # (default 1)
      logic-not-delete-value: 0     # (default 0)
```

ä½¿ç”¨ï¼šç„¶ååˆ° `com.becoze.usercenter.model.domain.User` å† `private Integer isDelete;` ä¸Šæ·»åŠ ä»¥ä¸‹æ³¨è§£ 

```java
/**
 * logical delete, 0 - not deleted, 1 - deleted
 */
@TableLogic
private Integer isDelete;
```



**"æ ¡éªŒç™»å½•å¯†ç "** **æœ€ç»ˆä»£ç ** ï¼ˆåªåŒ…å« `userLogin`ï¼Œä¸åŒ…å«Mybatis-Plusé…ç½® - åœ¨åˆ«çš„æ–‡ä»¶é‡Œå‘¢ï¼‰

```java
private static final String SALT = "becoze"
...
    // User input password must be same as database encrypted password
    //  Password encryption
    String encryptedPassword = DigestUtils.md5DigestAsHex((SALT + userPassword).getBytes());

    //  User account need to match exist account [database query]
    QueryWrapper<User> queryWrapper = new QueryWrapper<>();
    queryWrapper.eq("userAccount", userAccount);
    queryWrapper.eq("userPassword", encryptedPassword);
    User user = userMapper.selectOne(queryWrapper);
    if(user == null){
        log.info("User login Failed - User Account or Password incorrect/not-match");  // @Slf4j æ—¥å¿—
        return null;
    }
```

> æ³¨æ„ï¼š`queryWrapper.eq("userPassword", encryptedPassword);` ä¼ å…¥çš„æ˜¯åŠ å¯†åçš„å¯†ç ä¸æ˜¯ `userPassword` äº†ã€‚

### 5. è„±æ•ç”¨æˆ·ä¿¡æ¯

åˆ›å»ºæ–°çš„ `User` ç±»å‚¨å­˜è„±æ•åçš„ä¿¡æ¯ã€‚

```java
User desensitizedUser = new user();
```

Select `desensitizedUserInfo` -> click alt+enter -> "Generate all setter with default value"

remove `setUserPassword`, `setUserUpdateTime` and `setIsDelete`

```java
// 3. desensitization
User desensitizedUser =  new User();
desensitizedUser.setId(user.getId());
desensitizedUser.setUsername(user.getUsername());
desensitizedUser.setUserAccount(user.getUserAccount());
desensitizedUser.setAvatarUrl(user.getAvatarUrl());
desensitizedUser.setGender(user.getGender());
desensitizedUser.setPhone(user.getPhone());
desensitizedUser.setEmail(user.getEmail());
desensitizedUser.setUserStatus(user.getUserStatus());
desensitizedUser.setCreateTime(new Date());
```



### 6. è®°å½•ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ï¼ˆsessionï¼‰

**å¦‚ä½•çŸ¥é“æ˜¯å“ªä¸ªç”¨æˆ·ç™»å½•äº†ï¼Ÿ**

javaweb ç›¸å…³çŸ¥è¯†

1. è¿æ¥æœåŠ¡å™¨ç«¯åï¼Œå¾—åˆ°ä¸€ä¸ª session çŠ¶æ€ï¼ˆåŒ¿åä¼šè¯ï¼‰ï¼Œè¿”å›ç»™å‰ç«¯

2. ç™»å½•æˆåŠŸåï¼Œå¾—åˆ°äº†ç™»å½•æˆåŠŸçš„ sessionï¼Œå¹¶ä¸”ç»™è¯¥ session è®¾ç½®ä¸€äº›å€¼ï¼ˆæ¯”å¦‚ç”¨æˆ·ä¿¡æ¯ï¼‰ï¼Œè¿”å›ç»™å‰ç«¯ä¸€ä¸ªè®¾ç½® cookie çš„ â€å‘½ä»¤â€œ 

   **session => cookie** 

3. å‰ç«¯æ¥æ”¶åˆ°åç«¯çš„å‘½ä»¤åï¼Œè®¾ç½® cookieï¼Œä¿å­˜åˆ°æµè§ˆå™¨å†…

4. å‰ç«¯å†æ¬¡è¯·æ±‚åç«¯çš„æ—¶å€™ï¼ˆç›¸åŒçš„åŸŸåï¼‰ï¼Œåœ¨è¯·æ±‚å¤´ä¸­å¸¦ä¸Šcookieå»è¯·æ±‚

5. åç«¯æ‹¿åˆ°å‰ç«¯ä¼ æ¥çš„ cookieï¼Œæ‰¾åˆ°å¯¹åº”çš„ session

6. åç«¯ä» session ä¸­å¯ä»¥å–å‡ºåŸºäºè¯¥ session å­˜å‚¨çš„å˜é‡ï¼ˆç”¨æˆ·çš„ç™»å½•ä¿¡æ¯ã€ç™»å½•åï¼‰

åœ¨ `UserService.java` æ–¹æ³•å†æ·»åŠ ä¸€ä¸ª `HttpServletRequest request` å‚æ•°ã€‚

```java
User userLogin(String userAccount, String userPassword, HttpServletRequest request);
```

å»åˆ° `userLogin(...)` æ–¹æ³•é‡Œä¹Ÿæ·»åŠ ä¸€æ ·çš„å‚æ•° 

```java
public User userLogin(String userAccount, String userPassword, HttpServletRequest request)
```

å®šä¹‰ä¸€ä¸ªå…¬å…±ç”¨æˆ·ç™»å½•çŠ¶æ€çš„å€¼

```java
/**
* user Login status
*/
private static final String USER_LOGIN_STATUS = "userLoginStatus"; 
```

**â€è®°å½•ç”¨æˆ·çš„ç™»å½•æ€â€œ æœ€ç»ˆä»£ç **ï¼ˆåŒ…æ‹¬ä¸Šé¢çš„å€¼ï¼‰

```java
// 3. è®°å½•ç”¨æˆ·çš„ç™»å½•æ€
request.getSession().setAttribute(USER_LOGIN_STATUS, desensitizedUser);
```

### 7. è¿”å›è„±æ•åçš„ç”¨æˆ·ä¿¡æ¯

```java
return desensitizedUser;
```



## å°è£…æ§åˆ¶å±‚è¯·æ±‚æˆæ¥å£ - ç¼–å†™`Controller` æ–¹æ³•

è¯·æ±‚ (call arguments)

> æ–¹æ³•å’Œæ¥å£çš„åŒºåˆ«ï¼š
>
> æ–¹æ³•é€šå¸¸æŒ‡åç«¯ **å…·ä½“å®ç°ä¸šåŠ¡é€»è¾‘çš„æ–¹æ³•**ã€‚
>
> â€‹	å¦‚ï¼šService å±‚ã€‚æ˜¯å¯¹ä¸šåŠ¡é€»è¾‘çš„æ ¡éªŒï¼ˆæœ‰å¯èƒ½è¢« controller ä¹‹å¤–çš„ç±»è°ƒç”¨ï¼‰
>
> æ¥å£éœ€è¦æ ¹æ®åç«¯çš„ä¸šåŠ¡é€»è¾‘æ–¹æ³•è¿›è¡Œå°è£…ï¼Œç„¶åä¾›å‰ç«¯ä½¿ç”¨ã€‚å°½é‡ä¸æ¶‰åŠä¸šåŠ¡é€»è¾‘æœ¬èº«ã€‚
>
> â€‹	å¦‚ï¼šController å±‚ã€‚å€¾å‘äºå¯¹è¯·æ±‚å‚æ•°æœ¬èº«çš„æ ¡éªŒï¼Œä¸æ¶‰åŠä¸šåŠ¡é€»è¾‘æœ¬èº«ï¼ˆè¶Šå°‘è¶Šå¥½ï¼‰

### 1. `UserController` åˆå§‹åŒ–

> æŠŠJavaåå°å†™çš„ä»£ç å°è£…æˆä¸€ä¸ªæ¥å£ï¼Œå…è®¸å‰ç«¯å»è°ƒç”¨ã€‚

å³é”® `java.com.becoze.usercenter.controller` åŒ… -> New -> Java Class -> å‘½åä¸º `UcerController` 

è¿›å…¥ `UserController.java`ï¼Œ æ‰“ä¸Šä»¥ä¸‹æ³¨è§£ï¼š

```java
/**
* User interface 
* 
* @author nick
*/
@RestController
@RequestMapping("/user")
public class UserController { 
    ... 
}
```

> å®šä¹‰äº†è¿™ä¸ªç±»é‡Œé¢æ‰€æœ‰çš„è¯·æ±‚çš„æ¥å£å“åº”çš„æ•°æ®ç±»å‹éƒ½æ˜¯application Jsonã€‚`@RestController` é€‚ç”¨äºç¼–å†™ restful é£æ ¼çš„ï¼ˆä¸€ç§æ¥å£çš„é£æ ¼ï¼Œè§„èŒƒï¼‰apiã€‚

application.yml æŒ‡å®šæ¥å£å…¨å±€ api

```
servlet:
  context-path: /api
```



### 2. æ¥æ”¶ æ³¨å†Œ è¯·æ±‚å‚æ•° - ç¼–å†™ `request.UserRgisterRequest` 

å°è£…ä¸€ä¸ª â€œè¯·æ±‚å¯¹è±¡â€ ä¸“é—¨æ¥æ¥æ”¶æ‰€æœ‰çš„ æ³¨å†Œ è¯·æ±‚çš„å‚æ•°ï¼šå³é”® `model.domain` -> New -> Package -> name it `.request` -> å³é”® `model.domain.request` -> New -> Java class -> name it `UserRegisterRequest`

æ³¨é‡Šï¼š

```java
/**
* User Registration Request 
* @author nick
*/
public class UserRequestRequest implements Serializable {

}
```

> `implements Serializable` ç»§æ‰¿ Serializable åºåˆ—åŒ–æ¥å£çš„å®ç°ã€‚æä¾›åºåˆ—åŒ–ï¼Œå¹¶å¯ä»¥åœ¨åºåˆ—åŒ–å¯¹è±¡æ—¶é¿å…å†²çªã€‚

ç”Ÿæˆåºåˆ—åŒ–IDï¼šåœ¨ `{ }` ä»»æ„ä½ç½®å³é”® -> "Generate..." -> "SerialVersionUID"

```java
private static final long serialVersionUID = 12456789000000L; 
```

> [Java â€“ How to generate serialVersionUID](https://mkyong.com/java/how-to-generate-serialversionuid/)ã€‚ æˆ–è€… File -> Setting -> editor -> inspections -> search "UID" -> check "Serializable class without 'serialVersionUID' " -> ok
>
> Note: (InvalidClassException Error)
>
> hover the "UserRegisterRequest" -> lick alt+enter -> "add 'serialVersionUID field' "

å®šä¹‰å‰ç«¯éœ€è¦ä¼ å…¥çš„å‚æ•°ï¼š

```java
private String userAccount;
private String userPassword;
private String confirmPassword;
```

åŠ å…¥ `@Data` lombok æ³¨è§£è®©ä»–ç”Ÿæˆ get/set æ–¹æ³•

````java
@Data
public class UserRequestRequest implements Serializable {
	...
}
````

æœ€ç»ˆä»£ç ï¼š

```java
package com.becoze.usercenter.model.domain.request;

import lombok.Data;

import java.io.Serializable;

/**
 * User Registration Request
 * @author nick
 */
@Data
public class UserRegisterRequest implements Serializable {
    private static final long serialVersionUID = 3191241716373120793L;

    private String userAccount;
    private String userPassword;
    private String confirmPassword;
}
```

### 3. ç¼–å†™æ³¨å†Œè¯·æ±‚

è°ƒç”¨ serviceï¼Œå› ä¸ºè¿™ä¸ªè¯·æ±‚é‡Œé¢éœ€è¦è°ƒç”¨ä¸šåŠ¡é€»è¾‘ï¼š

```java
@Resource 
private UserService userService;
```

ç¼–å†™ç”¨æˆ·æ³¨å†Œæ¥å£ï¼š

åœ¨ `UserController` æ¥å£çš„è¯·æ±‚å‚æ•°çš„é‡Œï¼Œå»å¼•ç”¨è¿™ä¸ª `UserRegisterRequest` çš„ç”¨æˆ·è¾“å…¥å‚æ•°ã€‚è¿˜è¦æ‰“ä¸Š `@RequestBody` æ³¨è§£ï¼š

```java
@PostMapping("/register")
public Long userRegister(@RequestBody UserRegisterRequest userRegisterRequest){
    ...
}
```

> `@RequestBody` å‘Šè¯‰ spring mvc æ¡†æ¶ï¼ŒæŠŠå‰ç«¯ä¼ æ¥çš„ json å‚æ•°å»å…³è”åˆé€‚çš„å¯¹è±¡

å®šä¹‰å’Œå‚¨å­˜æ”¶çš„å‚æ•°ï¼Œå’Œå¯¹å‚æ•°æœ¬èº«çš„ç®€å•æ ¡éªŒï¼ˆController çš„ä¸æ¶‰åŠä¸šåŠ¡é€»è¾‘ï¼‰ã€‚

ç®€å•çš„æ ¡éªŒ `userLoginRequest == null` å’Œ `StringUtils.*isAnyBlank*(userAccount, userPassword)`

**æœ€ç»ˆä»£ç ï¼š**

```java
@PostMapping("/register")
public Long userRegister(@RequestBody UserRegisterRequest userRegisterRequest){
    if (userRegisterRequest == null) {
        return null;
    }
    // å®šä¹‰å’Œå‚¨å­˜æ¥æ”¶çš„å‚æ•°
    String userAccount = userRegisterRequest.getUserAccount();
    String userPassword = userRegisterRequest.getUserPassword();
    String confirmPassword = userRegisterRequest.getConfirmPassword();
    // å¯¹è¾“å…¥å‚æ•°æœ¬èº«çš„ç®€å•æ ¡éªŒ simple check of the input, end the service here if any blank before go into service.
    if(StringUtils.isAnyBlank(userAccount, userPassword, confirmPassword)){
        return null;
    }
    return userService.userRegister(userAccount, userPassword, confirmPassword);
}
```



### 4. æ¥æ”¶ ç™»å½• è¯·æ±‚å‚æ•° - ç¼–å†™ `request.UserLoginRequest` 

å°è£…ä¸€ä¸ª â€œè¯·æ±‚å¯¹è±¡â€ ä¸“é—¨æ¥æ¥æ”¶æ‰€æœ‰çš„ ç™»å½• è¯·æ±‚çš„å‚æ•°ï¼šåœ¨`model.domain.request` ä¸­ï¼Œå¤åˆ¶ `UserRegisterRequest` ç²˜è´´åˆ°å½“å‰ç›®å½•ä¸‹ï¼Œå‘½åä¸º `UserLoginRequest`ã€‚

![image-20230511192445349](C:\Users\liyua\AppData\Roaming\Typora\typora-user-images\image-20230511192445349.png)

ä¿®æ”¹æ³¨é‡Šã€‚åˆ é™¤ `private String confirmPassword;`ã€‚**æœ€ç»ˆä»£ç ï¼š**

```java
package com.becoze.usercenter.model.domain.request;

import lombok.Data;

import java.io.Serializable;

/**
 * User Login Request
 * @author nick
 */
@Data
public class UserLoginRequest implements Serializable {
    private static final long serialVersionUID = 3191241716373120793L;

    private String userAccount;
    private String userPassword;
}
```



### 5. ç¼–å†™ç™»å½•è¯·æ±‚

åœ¨ `controller.UcerController` é‡Œå¤åˆ¶ä¸€ä»½ `userRegister()` æ–¹æ³•ã€‚

é‡å‘½åä¸º `userLogin`ã€‚

å¹¶æŠŠè¿”å›å‚æ•° `Long` ç±»æ”¹æˆ `User`ç±»ã€‚

åŠ ä¸Š `HttpServletRequest request` å‚æ•°ã€‚

```java
@PostMapping("/login")
public User userLogin(@RequestBody UserLoginRequest userLoginRequest, HttpServletRequest request){
    ...
}
```



å¯¼å…¥ `User` åŒ… `import com.becoze.usercenter.model.domain.User;`

åˆ é™¤ç¡®è®¤å¯†ç çš„æ ¡éªŒ `String confirmPassword = userRegisterRequest.getConfirmPassword();`

æŠŠæ‰€æœ‰çš„ `userRegisterRequest` æˆ–åˆ é™¤ï¼Œæˆ–æ”¹æˆ  `userLoginRequest`ã€‚

`return` æ”¹æˆè°ƒç”¨ `userLogin` æ–¹æ³•ï¼Œå¹¶åŠ ä¸Š `request` å‚æ•°ã€‚

**æœ€ç»ˆä»£ç ï¼š**

```java
@PostMapping("/login")
public User userLogin(@RequestBody UserLoginRequest userLoginRequest, HttpServletRequest request){
    if (userLoginRequest == null) {
        return null;
    }
    // define the Two argument we are receiving
    String userAccount = userLoginRequest.getUserAccount();
    String userPassword = userLoginRequest.getUserPassword();
    // simple check of the input, end the service here if any blank before go into service.
    if(StringUtils.isAnyBlank(userAccount, userPassword)){
        return null;
    }
    return userService.userLogin(userAccount, userPassword, request);
}
```



### ï¼ˆ6. Error - ç¼ºå¤±æ¥å£åœ°å€ï¼‰

```java
Error starting ApplicationContext. To display the conditions report re-run your application with 'debug' enabled.
2023-05-13 19:01:21.529 ERROR 7164 --- [  restartedMain] o.s.boot.SpringApplication               : Application run failed

org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'requestMappingHandlerMapping' defined in class path resource [.../servlet/WebMvcAutoConfiguration$EnableWebMvcConfiguration.class]: Invocation of init method failed; nested exception is java.lang.IllegalStateException: Ambiguous mapping. Cannot map 'userController' method 

// the Key is below 
com.becoze.usercenter.controller.UserController#userLogin(UserLoginRequest, HttpServletRequest)
to {POST [/user]}: There is already 'userController' bean method
com.becoze.usercenter.controller.UserController#userRegister(UserRegisterRequest) mapped.
```

Reason: ç¼ºå¤±æ¥å£åœ°å€

Solution: 

`@RequestMapping("/user")` : `UserController` `@RequestMapping` missing `("/user")`

` @PostMapping("/login")`: `UserController`  `@PostMapping` missing `("/register")` and/or `("/login")`



## æµ‹è¯•åç«¯æ¥å£ - IDEA http æµ‹è¯•å·¥å…·

### API é€šå¸¸æµ‹è¯•

æ‰“å¼€æµ‹è¯•çª—å£ï¼šç‚¹å‡» Controller userLogin æ—è¾¹çš„æŒ‰é’®ã€‚

![image-20230513180411081](C:\Users\liyua\AppData\Roaming\Typora\typora-user-images\image-20230513180411081.png)

æˆ– Tools -> HTML clients -> Create Request in HTTP Client

![image-20230513174655697](C:\Users\liyua\AppData\Roaming\Typora\typora-user-images\image-20230513174655697.png)

åˆ é™¤åŸæœ‰çš„é»˜è®¤è¯·æ±‚ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå†™å…¥ä»¥ä¸‹è¯·æ±‚ã€‚

```http
POST http://localhost:8080/user/login
Content-Type: application/json
{

}
```

ä»¥ Debug æ¨¡å¼å¯åŠ¨ï¼ˆå³ä¸Šè§’ï¼‰ã€‚

![image-20230513180000333](C:\Users\liyua\AppData\Roaming\Typora\typora-user-images\image-20230513180000333.png)

åœ¨ `{ }` é‡Œå¡«å†™è¯·æ±‚çš„æ•°æ®ï¼Œå°è¯•ç™»å½•ä¸€ä¸ªå·²æœ‰çš„ç”¨æˆ·ã€‚

```http
POST http://localhost:8080/user/login
Content-Type: application/json
{
	"userAccount": "validaccount",
	"userPassword": mypassword123
}

###
```

> `userAccount = "validaccount"; userPassword = "mypassword123";` å¯åœ¨ `test.java.com.service.UserServiceTest` é‡ŒæŸ¥çœ‹ã€‚
>
> å½“å‰çš„ `rest-api.http` æ–‡æ¡£ä¼šå‚¨å­˜åœ¨ `Scratches and Consoles.Scratches` é‡Œã€‚

åœ¨ `UserController` æ‰“ä¸Šä»¥ä¸‹æ–­ç‚¹ï¼š

![image-20230513181148675](C:\Users\liyua\AppData\Roaming\Typora\typora-user-images\image-20230513181148675.png)

åœ¨ `UserService.userLogin()` æ–¹æ³•é‡Œï¼Œæ‰“ä¸Šä»¥ä¸‹æ–­ç‚¹ï¼š

![image-20230515213602485](C:\Users\liyua\AppData\Roaming\Typora\typora-user-images\image-20230515213602485.png)

å›åˆ° `rest-api.http` æµ‹è¯•å·¥å…·ï¼Œç‚¹å‡»å³ä¾§è¿è¡ŒæŒ‰é’®ï¼Œé€‰æ‹© "Run localhost:8080"ã€‚

ç•Œé¢ä¼šè‡ªåŠ¨è·³è½¬åˆ° `UserController` å¹¶æ‰§è¡Œã€‚ä¸€ç›´æŒ‰ F8 ä¸‹ä¸€æ­¥ã€‚

`UserController` ç»“æŸåä¼šè‡ªåŠ¨è·³è½¬ï¼ˆå¯èƒ½è¦1~5ç§’ï¼‰åˆ° `InvocableHandlerMrthod.class`

æµ‹è¯•å®Œæˆåï¼Œæµ‹è¯•å·¥å…· `rest-api.http` ä¼šå¤šå‡ºè¿”å›å€¼ã€‚

![image-20230515212559180](C:\Users\liyua\AppData\Roaming\Typora\typora-user-images\image-20230515212559180.png)

æŒ‰ä½ ctrl+é¼ æ ‡å³é”® è¿›å…¥ï¼Œæˆ–æŠŠå…‰æ ‡æ”¾ä¸Šå»ï¼ŒæŒ‰ ctrl+b è¿›å…¥ã€‚æŸ¥çœ‹è¿”å›å€¼ã€‚

![image-20230515212801047](C:\Users\liyua\AppData\Roaming\Typora\typora-user-images\image-20230515212801047.png)

### ç»„ä»¶â€œé€»è¾‘åˆ é™¤â€ æµ‹è¯•

> å› ä¸ºæ˜¯å¼•å…¥çš„ `MyBatisPlus` ä¸æ˜¯è‡ªå·±å†™çš„ï¼Œæ‰€ä»¥è¦æµ‹è¯•ä¸€ä¸‹ã€‚

å»åˆ° Database -> user ç›´æ¥åœ¨è¡¨ä¸ŠåŒå‡»ï¼ŒæŠŠ `validaccount` çš„ `isDelete` æ”¹æˆ1ï¼ˆåˆ é™¤äº†ï¼‰ã€‚ç„¶åç‚¹å‡» `Submit` æˆ– ctrl + Enterã€‚

æ‰§è¡ŒåŒæ ·çš„ `rest-api.http`ã€‚ç¨‹åºä¼šåœ¨ä¸‹é¢ä»£ç å¤„ç»“æŸï¼ˆç”¨æˆ·ä¸å­˜åœ¨user not exist `return null`ï¼‰ã€‚

```java
QueryWrapper<User> queryWrapper = new QueryWrapper<>();
queryWrapper.eq("userAccount", userAccount);
queryWrapper.eq("userPassword", encryptedPassword);
User user = userMapper.selectOne(queryWrapper);
//  user not exist
if(user == null){
    log.info("User login Failed - User Account or Password incorrect/not-match");
    return null;
}
```
